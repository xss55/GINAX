library(DBI)
library(tableone)
library(DT)
library(RPostgres)
library(RColorBrewer)
library(dplyr)
library(emmeans)
rm(list = ls())
###############################
###############################
###############################
###############################
#For Shuangshuang
con <- dbConnect(RPostgres::Postgres(),dbname = 'emp',
host = 'arrc-prd-db01.vtcri.local',
port = 5432,
user = 'xshuangshuang',
password = 'Heizi230315@')
Taxesquery <- dbSendQuery(con, "
SELECT
session.id, mgr_exp.name AS expname, mgr_expsessionplan.started, mgr_expsessionplan.finished, emp_session.allowance,
session.subjname AS arrcsubj_id, session.expsessionname AS arrcsession_id, mgr_expplan.desc, visitnewest.raname AS arrcra_id,
emp_sessionproduct.name, emp_sessionproduct.description, emp_sessionproduct.price, emp_sessionproduct.unit, category,
CASE WHEN emp_sessioncart.qty IS NULL THEN 0 ELSE emp_sessioncart.qty END AS qty
FROM emp_session
INNER JOIN emp_sessionproduct ON emp_sessionproduct.session_id = emp_session.id
LEFT OUTER JOIN emp_sessioncart ON emp_sessioncart.session_id = emp_session.id AND emp_sessioncart.sessionproduct_id = emp_sessionproduct.id
INNER JOIN mgr_expsessionplan ON mgr_expsessionplan.id = emp_session.mgrexpsessionplan_id
INNER JOIN mgr_expsession ON mgr_expsession.id = mgr_expsessionplan.mgrexpsession_id
INNER JOIN mgr_expplan ON mgr_expplan.id = mgr_expsessionplan.mgrexpplan_id
INNER JOIN session ON session.id = mgr_expsession.session_id
INNER JOIN (
SELECT DISTINCT ON (session_id) raname, session_id
FROM visit
ORDER BY session_id, created DESC
) AS visitnewest ON visitnewest.session_id = session.id
INNER JOIN mgr_exp ON mgr_exp.id = session.mgrexp_id
WHERE emp_session.deleted IS NULL
AND session.voided IS NULL
AND emp_session.completed IS NOT NULL
AND emp_sessionproduct.visible = TRUE
AND mgr_exp.name = 'ETM Taxes Study 2'
ORDER BY id DESC
;")
Taxes <- dbFetch(Taxesquery)
View(Taxes)
54*0.81
53*0.81
Taxesquery <- dbSendQuery(con, "
SELECT *
FROM emp_session
INNER JOIN emp_sessionproduct ON emp_sessionproduct.session_id = emp_session.id
LEFT OUTER JOIN emp_sessioncart ON emp_sessioncart.session_id = emp_session.id AND emp_sessioncart.sessionproduct_id = emp_sessionproduct.id
INNER JOIN mgr_expsessionplan ON mgr_expsessionplan.id = emp_session.mgrexpsessionplan_id
INNER JOIN mgr_expsession ON mgr_expsession.id = mgr_expsessionplan.mgrexpsession_id
INNER JOIN mgr_expplan ON mgr_expplan.id = mgr_expsessionplan.mgrexpplan_id
INNER JOIN session ON session.id = mgr_expsession.session_id
INNER JOIN (
SELECT DISTINCT ON (session_id) raname, session_id
FROM visit
ORDER BY session_id, created DESC
) AS visitnewest ON visitnewest.session_id = session.id
INNER JOIN mgr_exp ON mgr_exp.id = session.mgrexp_id
WHERE emp_session.deleted IS NULL
AND session.voided IS NULL
AND emp_session.completed IS NOT NULL
AND emp_sessionproduct.visible = TRUE
AND mgr_exp.name = 'ETM Taxes Study 2'
ORDER BY id DESC
;")
View(Taxes)
Taxesquery <- dbSendQuery(con, "
SELECT *
FROM emp_session
INNER JOIN emp_sessionproduct ON emp_sessionproduct.session_id = emp_session.id
LEFT OUTER JOIN emp_sessioncart ON emp_sessioncart.session_id = emp_session.id AND emp_sessioncart.sessionproduct_id = emp_sessionproduct.id
INNER JOIN mgr_expsessionplan ON mgr_expsessionplan.id = emp_session.mgrexpsessionplan_id
INNER JOIN mgr_expsession ON mgr_expsession.id = mgr_expsessionplan.mgrexpsession_id
INNER JOIN mgr_expplan ON mgr_expplan.id = mgr_expsessionplan.mgrexpplan_id
INNER JOIN session ON session.id = mgr_expsession.session_id
INNER JOIN (
SELECT DISTINCT ON (session_id) raname, session_id
FROM visit
ORDER BY session_id, created DESC
) AS visitnewest ON visitnewest.session_id = session.id
INNER JOIN mgr_exp ON mgr_exp.id = session.mgrexp_id
WHERE emp_session.deleted IS NULL
AND session.voided IS NULL
AND emp_session.completed IS NOT NULL
AND emp_sessionproduct.visible = TRUE
AND mgr_exp.name = 'ETM Taxes Study 2'
;")
Taxes_temp <- dbFetch(Taxesquery)
View(Taxes_temp)
View(Taxes_temp[Taxes_temp$desc == "TP Trial 2" & Taxes_temp$session.subjname == "MB21380",])
colnames(Taxes_temp)
View(Taxes_temp[Taxes_temp$desc == "TP Trial 2" & Taxes_temp$subjname == "MB21380",])
View(Taxes_temp[Taxes_temp$desc == "TP Trial 2" & Taxes_temp$subjname == "MB21380" & !is.na(Taxes_temp$qty),])
apply(Taxes_temp[Taxes_temp$desc == "TP Trial 2" & Taxes_temp$subjname == "MB21380" & !is.na(Taxes_temp$qty),],2,unique)
f <- function(x){length(unique(x))}
apply(Taxes_temp[Taxes_temp$desc == "TP Trial 2" & Taxes_temp$subjname == "MB21380" & !is.na(Taxes_temp$qty),],2,f)
sum(apply(Taxes_temp[Taxes_temp$desc == "TP Trial 2" & Taxes_temp$subjname == "MB21380" & !is.na(Taxes_temp$qty),],2,f) > 1)
